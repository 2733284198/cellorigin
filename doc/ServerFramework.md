# 服务器框架
服务器逻辑框架基于Trigger-Condition-Action系统构建, 简称TCA

## TCA系统优劣

### 优点

* 统一的框架可以应对需求的随意变化

* 归一化的架构, 可以方便应对各种查询, 挂接等临时需求

* 数据驱动模型, 热更新方便

* 日志化输出便于调试, 跟踪

### 缺点
* 一般开发人员无法归一化理解

* 性能略低( 可使用代码生成 )

## 基本定义

### Trigger系统
* 事件可作为一种Trigger使用枚举描述类型

* 将玩家的对某个模块的操作的网络消息视为一种Trigger

* Trigger使用枚举描述类型, 在代码中实现逻辑, 电子表格中使用

* Timer计时器定点触发, 分真实时间和在线时间两种, 代码层可独立范围触发器状态及数值
	类型: 某天某时刻触发, 倒计时触发

### Condition系统

* 表达式部分, 使用一个小型解析器进行预处理解析为AST给后端进行逻辑运算, 让复杂条件写起来比较简便

* Condition有独立的配置表, 1行表示1个独立条件

* 玩家消息可以被透传到Condition中做自定义判断

* 时间系统也是归属于Condition
	例如: 满足A系统每天5点后(跨天), 满足B系统每天零点后(跨天)

### Action系统

* 由代码将操作注册到系统中

* Action中会存在再次触发Trigger情况, 应该避免自我触发和递归情况


### Rule系统
* 一套Trigger-Condition-Action系统可称作为一个Rule
* Rule有优先度可以调节

注意:
* TCA是所有模块的基础


* TCA每个独立系统不一定拥有一个独立的电子表格配置, 只有proto和代码系统描述

* 每个模块会有独立的TCA系统字段的描述, 通过代码组装并使用TCA系统




## 需求用例

* 如何使用TCA系统描述一个任务

Trigger表示任务发生时间点, Condition作条件检查,例如等级约束,出现时机及任务本身的基本条件约束

Action内应填写: 写任务记录, 发放奖励, 打开新的任务链

任务链的前后关联发生变化时的刷新问题: 为代码模块和玩家数据中模块建立版本维护, 版本不同时, 执行一个Action进行任务链的刷新操作

* 进入关卡流程用TCA来描述

Trigger配置 玩家请求进入

Condition表配置各种约束, 例如: 进入关卡的等级区间, 体力>0, 进入次数>0

Action:  扣减体力,扣减进入次数, 写BI日志, 进入关卡具体逻辑状态设置等


* 完成关卡流程用TCA来描述

Trigger配置 关卡结束

Action配置 写关卡记录(星级, 结果), 发奖励

* 处理首次通关奖励

Trigger配置 关卡结束

Condition配置 通关次数==1

Action配置, 发奖励

* 技能升级

Trigger配置 玩家请求技能升级

Condition配置 玩家等级范围, 金币, 技能点是否满足

Action 增加技能点, 写BI日志

* 某系统需要每天5点重置一次次数

Trigger配置 玩家登录

Condition配置 每天5点后

Action配置 重置点数